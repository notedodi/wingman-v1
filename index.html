<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wingman - Sistem Deposit Dokter</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': [
                            "Inter", "SF Pro Display", "-apple-system", "BlinkMacSystemFont",
                            "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell",
                            "Open Sans", "Helvetica Neue", "sans-serif"
                        ],
                    },
                    colors: {
                        'primary': {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa',
                            '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a',
                            '950': '#172554',
                        },
                        'success': '#22c55e',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>

    <!-- jsPDF and jsPDF-AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        html {
            font-size: 15px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
        }

        .dark body {
            background-color: #0f172a;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 100px;
        }

        main::-webkit-scrollbar {
            width: 6px;
        }

        main::-webkit-scrollbar-track {
            background: transparent;
        }

        .dark main::-webkit-scrollbar-track {
            background: #1e293b;
        }

        main::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .dark main::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        .page {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-item.active {
            color: #2563eb;
        }

        .dark .nav-item.active {
            color: #60a5fa;
        }

        .nav-item.active .nav-text {
            font-weight: 600;
        }

        .form-input {
            background-color: #f9fafb;
            border-color: #d1d5db;
            transition: all 0.2s ease-in-out;
        }

        .dark .form-input {
            background-color: #1e293b;
            border-color: #4b5563;
        }

        .form-input:focus {
            box-shadow: 0 0 0 2px #bfdbfe;
            border-color: #60a5fa;
            outline: none;
        }

        .dark .form-input:focus {
            box-shadow: 0 0 0 2px #1e3a8a;
            border-color: #3b82f6;
        }

        .transaction-type-btn.active.income {
            background-color: #22c55e;
            color: white;
            border-color: #22c55e;
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3);
        }

        .transaction-type-btn.active.expense {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }

        #modal-container.hidden {
            display: none;
        }

        #modal-container {
            animation: fadeInModalBg 0.3s ease-out forwards;
        }

        #modal-container>div {
            animation: zoomInModal 0.3s ease-out forwards;
        }

        @keyframes fadeInModalBg {
            from {
                background-color: rgba(0, 0, 0, 0);
            }

            to {
                background-color: rgba(0, 0, 0, 0.5);
            }
        }

        @keyframes zoomInModal {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
        }
    </style>
    <script>
        if (localStorage.getItem('wingmanTheme') === 'dark' || (!('wingmanTheme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body class="text-gray-800 dark:text-gray-200">

    <!-- Login Page -->
    <div id="login-page"
        class="relative flex flex-col items-center justify-center h-full w-full p-4 text-center bg-gradient-to-br from-primary-500 to-primary-700">
        <div class="absolute top-0 left-0 w-full h-full bg-cover opacity-10"
            style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
        <div
            class="relative bg-white/20 dark:bg-gray-800/30 backdrop-blur-xl p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-white/30">
            <div class="flex justify-center items-center mb-5"> <i class="fas fa-notes-medical text-5xl text-white"></i>
                <h1 class="text-4xl font-bold text-white ml-4">Wingman</h1>
            </div>
            <p class="text-primary-100 mb-10">Asisten Deposit Dokter Kepercayaan Anda.</p>
            <button id="btn-google-login"
                class="bg-white text-primary-700 w-full py-3 rounded-xl shadow-lg hover:bg-primary-50 transition-all duration-300 font-semibold flex items-center justify-center gap-3 text-lg transform hover:scale-105">
                <i class="fab fa-google"></i> <span>Masuk dengan Google</span>
            </button>
            <div id="login-loader" class="hidden mt-4"> <i class="fas fa-spinner fa-spin text-3xl text-white"></i>
            </div>
        </div>
        <footer class="absolute bottom-0 left-0 right-0 text-center py-6 px-4 text-sm text-primary-200">
            <p>© 2025 Wingman. Dibuat dengan ❤️ oleh Dodi Outright.</p>
        </footer>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden h-full w-full flex flex-col">
        <main>
            <!-- Page: Home/Dashboard -->
            <div id="page-home" class="page p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 id="user-greeting" class="text-xl font-bold text-gray-900 dark:text-white"></h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Selamat datang kembali!</p>
                        </div>
                        <div class="w-1/2 sm:w-1/3">
                            <select id="doctor-select-dashboard"
                                class="form-input w-full p-2 border rounded-lg text-sm"></select>
                        </div>
                    </div>
                    <div id="dashboard-content" class="space-y-5"></div>
                    <div id="contact-suggestion-box"
                        class="hidden mt-4 relative bg-blue-100 dark:bg-slate-800 border-l-4 border-blue-500 dark:border-blue-400 p-4 rounded-r-lg">
                        <button id="close-suggestion-box"
                            class="absolute top-2 right-2 text-blue-400 hover:text-blue-600 dark:hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                        <p class="text-sm text-blue-800 dark:text-blue-200 pr-4">
                            Jika ada masalah atau saran fitur baru, silakan hubungi
                            <a href="https://api.whatsapp.com/send?phone=6287881000098" target="_blank"
                                class="font-bold underline hover:text-blue-600 dark:hover:text-white">Dodi Outright</a>.
                        </p>
                    </div>

                    <div id="recent-transactions-section" class="mt-6 hidden">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Transaksi Terbaru</h2>
                            <button id="show-all-transactions-btn"
                                class="text-xs font-medium text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 hidden">
                                Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div id="recent-transactions-container"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Doctor Management -->
            <div id="page-doctors" class="page hidden p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Manajemen Dokter</h1>
                        <div class="relative w-full sm:w-auto">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="search" id="doctor-search-input" placeholder="Cari dokter..."
                                class="form-input text-sm w-full sm:w-64 pl-9 p-2 border rounded-lg">
                        </div>
                        <button id="btn-add-doctor"
                            class="w-full sm:w-auto bg-primary-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-primary-700 transition-all duration-300 flex items-center justify-center gap-2 font-semibold text-sm transform hover:scale-105">
                            <i class="fas fa-user-plus"></i> <span>Tambah</span>
                        </button>
                    </div>
                    <div id="doctor-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Page: Transactions -->
            <div id="page-transactions" class="page hidden p-4">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Daftar Transaksi</h1>
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-4 bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
                        <input type="text" id="filter-search" placeholder="Cari deskripsi..."
                            class="form-input w-full p-2 border rounded-lg text-sm lg:col-span-2">
                        <select id="filter-doctor" class="form-input w-full p-2 border rounded-lg text-sm"></select>
                        <input type="date" id="filter-start-date"
                            class="form-input w-full p-2 border rounded-lg text-sm text-gray-500">
                        <input type="date" id="filter-end-date"
                            class="form-input w-full p-2 border rounded-lg text-sm text-gray-500">
                    </div>
                    <div id="transaction-summary"
                        class="hidden bg-blue-50 dark:bg-slate-800 p-3 rounded-xl shadow-sm my-4"></div>

                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden">
                        <div
                            class="flex flex-wrap justify-between items-center p-4 gap-2 border-b border-gray-200 dark:border-slate-700">
                            <div class="flex gap-2">
                                <button id="sort-by-date"
                                    class="text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors text-xs font-medium flex items-center gap-1">
                                    <i class="fas fa-sort"></i> Urutkan Tanggal </button>
                                <button id="reset-filters-btn"
                                    class="text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors text-xs font-medium flex items-center gap-1">
                                    <i class="fas fa-undo"></i> Reset Filter </button>
                            </div>
                            <button id="btn-export"
                                class="bg-success text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-green-600 flex items-center gap-2 transition-all transform hover:scale-105">
                                <i class="fas fa-file-export"></i>Ekspor </button>
                        </div>
                        <nav id="time-group-tabs" class="flex justify-around p-1 bg-gray-50 dark:bg-slate-900/50"
                            aria-label="Tabs">
                            <button data-group="day"
                                class="group-tab text-gray-600 dark:text-gray-300 flex-1 py-2 font-medium text-xs rounded-lg transition-all">Harian</button>
                            <button data-group="week"
                                class="group-tab text-gray-600 dark:text-gray-300 flex-1 py-2 font-medium text-xs rounded-lg transition-all">Mingguan</button>
                            <button data-group="month"
                                class="group-tab text-gray-600 dark:text-gray-300 flex-1 py-2 font-medium text-xs rounded-lg transition-all">Bulanan</button>
                            <button data-group="year"
                                class="group-tab text-gray-600 dark:text-gray-300 flex-1 py-2 font-medium text-xs rounded-lg transition-all">Tahunan</button>
                        </nav>
                        <div id="transaction-table-container" class="overflow-x-auto"></div>
                        <div id="pagination-controls" class="p-4 border-t border-gray-200 dark:border-slate-700"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Profile -->
            <div id="page-profile" class="page hidden p-4">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white mb-5">Profil & Pengaturan</h1>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center">
                        <img id="profile-avatar" src="https://placehold.co/100x100/E2E8F0/4A5568?text=U"
                            alt="User Avatar"
                            class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-primary-200 dark:border-primary-700 shadow-md">
                        <h2 id="profile-name" class="text-xl font-semibold text-gray-900 dark:text-white">Nama Pengguna
                        </h2>
                        <p id="profile-email" class="text-sm text-gray-500 dark:text-gray-400">email@pengguna.com</p>
                        <button id="btn-edit-profile"
                            class="mt-4 bg-gray-200 text-gray-800 px-4 py-1.5 rounded-lg hover:bg-gray-300 dark:bg-slate-700 dark:text-gray-200 dark:hover:bg-slate-600 font-semibold transition-colors text-xs">
                            <i class="fas fa-pencil-alt mr-1"></i> Edit Profil
                        </button>

                        <div class="mt-8 space-y-4 max-w-sm mx-auto">
                            <div
                                class="flex justify-between items-center bg-gray-100 dark:bg-slate-700/50 p-3 rounded-lg">
                                <div class="flex items-center gap-3"> <i
                                        class="fas fa-moon text-primary-600 dark:text-primary-400"></i> <span
                                        class="font-medium text-sm text-gray-700 dark:text-gray-200">Mode Gelap</span>
                                </div>
                                <button id="theme-toggle"
                                    class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-300 dark:bg-slate-600">
                                    <span id="theme-icon-container"
                                        class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6">
                                        <i id="theme-icon" class="fas text-yellow-400"></i> </span> </button>
                            </div>
                            <button id="btn-logout"
                                class="w-full bg-danger text-white px-4 py-2.5 rounded-lg hover:bg-red-600 transition-colors font-semibold flex items-center justify-center gap-2 text-sm">
                                <i class="fas fa-sign-out-alt"></i>Keluar </button>
                        </div>
                    </div>
                    <footer class="text-center py-8 px-4 text-xs text-gray-500 dark:text-gray-400">
                        <p>© 2025 Wingman. All Rights Reserved.</p>
                        <p class="mt-1">Made with ❤️ by Dodi Outright.</p>
                    </footer>
                </div>
            </div>
        </main>
        <div class="fixed bottom-0 left-0 right-0 z-40 flex justify-center">
            <nav
                class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg flex justify-around items-center h-16 w-full max-w-md mx-auto shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)] rounded-t-2xl border-t border-x border-gray-200/80 dark:border-slate-700/80">
                <button data-page="home"
                    class="nav-item flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 w-1/5 h-full transition-colors active">
                    <i class="fas fa-home text-xl"></i> <span class="nav-text text-xs mt-1">Home</span> </button>
                <button data-page="doctors"
                    class="nav-item flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 w-1/5 h-full transition-colors">
                    <i class="fas fa-user-doctor text-xl"></i> <span class="nav-text text-xs mt-1">Dokter</span>
                </button>
                <div class="w-1/5 flex justify-center"> <button id="btn-add-transaction-fab"
                        class="w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl transform -translate-y-4 border-4 border-white dark:border-slate-800 hover:bg-primary-700 transition-all duration-300 hover:rotate-90">
                        <i class="fas fa-plus"></i> </button> </div> <button data-page="transactions"
                    class="nav-item flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 w-1/5 h-full transition-colors">
                    <i class="fas fa-receipt text-xl"></i> <span class="nav-text text-xs mt-1">Transaksi</span>
                </button> <button data-page="profile"
                    class="nav-item flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 w-1/5 h-full transition-colors">
                    <i class="fas fa-user-circle text-xl"></i> <span class="nav-text text-xs mt-1">Profil</span>
                </button>
            </nav>
        </div>
    </div>
    <div id="modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Other modals remain unchanged -->
        <div id="modal-doctor" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-md hidden">
            <h2 id="modal-doctor-title" class="text-lg font-bold mb-6 text-gray-900 dark:text-white">Tambah Dokter Baru
            </h2>
            <form id="form-doctor"> <input type="hidden" id="doctor-id">
                <div> <label for="doctor-name"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Dokter</label>
                    <input type="text" id="doctor-name"
                        class="form-input text-sm mt-1 block w-full border rounded-md shadow-sm p-3" required
                        autocomplete="off"> </div>
                <div class="mt-8 flex justify-end space-x-3"> <button type="button"
                        class="btn-cancel bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 font-semibold transition-colors text-sm">Batal</button>
                    <button type="submit"
                        class="bg-primary-600 text-white px-5 py-2 rounded-lg hover:bg-primary-700 w-28 font-semibold transition-colors disabled:bg-primary-300 dark:disabled:bg-primary-800 text-sm">Simpan</button>
                </div>
            </form>
        </div>
        <div id="modal-transaction" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-md hidden">
            <h2 id="modal-transaction-title" class="text-lg font-bold mb-6 text-gray-900 dark:text-white">Tambah
                Transaksi</h2>
            <form id="form-transaction" class="space-y-4 text-sm"> <input type="hidden" id="transaction-id">
                <div> <label for="transaction-doctor"
                        class="block font-medium text-gray-700 dark:text-gray-300 mb-1">Dokter</label> <select
                        id="transaction-doctor"
                        class="form-input mt-1 block w-full border rounded-md shadow-sm p-3 bg-white" required></select>
                </div>
                <div> <label class="block font-medium text-gray-700 dark:text-gray-300">Jenis Transaksi</label>
                    <div class="mt-2 flex rounded-md"> <button type="button" data-type="income"
                            class="transaction-type-btn income flex-1 px-4 py-2.5 rounded-l-lg border bg-white font-medium text-gray-700 dark:bg-slate-700 dark:text-gray-200 dark:border-slate-600">Pemasukan</button>
                        <button type="button" data-type="expense"
                            class="transaction-type-btn expense flex-1 -ml-px px-4 py-2.5 rounded-r-lg border bg-white font-medium text-gray-700 dark:bg-slate-700 dark:text-gray-200 dark:border-slate-600">Pengeluaran</button>
                    </div> <input type="hidden" id="transaction-type" required>
                </div>
                <div> <label for="transaction-amount"
                        class="block font-medium text-gray-700 dark:text-gray-300 mb-1">Jumlah</label> <input
                        type="text" id="transaction-amount"
                        class="form-input mt-1 block w-full border rounded-md shadow-sm p-3" required
                        inputmode="numeric" placeholder="Contoh: 50.000"> </div>
                <div> <label for="transaction-description"
                        class="block font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi</label> <input
                        type="text" id="transaction-description"
                        class="form-input mt-1 block w-full border rounded-md shadow-sm p-3" required autocomplete="off"
                        placeholder="Contoh: Deposit pasien, Beli ATK"> </div>
                <div> <label for="transaction-date"
                        class="block font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal</label> <input
                        type="datetime-local" id="transaction-date"
                        class="form-input mt-1 block w-full border rounded-md shadow-sm p-3" required> </div>
                <div class="pt-4 flex justify-end space-x-3"> <button type="button"
                        class="btn-cancel bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 font-semibold transition-colors">Batal</button>
                    <button type="submit"
                        class="bg-primary-600 text-white px-5 py-2 rounded-lg hover:bg-primary-700 w-28 font-semibold transition-colors disabled:bg-primary-300 dark:disabled:bg-primary-800">Simpan</button>
                </div>
            </form>
        </div>
        <div id="modal-export" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-md hidden">
            <h2 class="text-lg font-bold mb-6 text-gray-900 dark:text-white">Opsi Ekspor Laporan</h2>
            <form id="form-export" class="space-y-3 text-sm"> <input type="text" id="export-title"
                    class="form-input block w-full border rounded-md p-3" placeholder="Judul Laporan (Opsional)"> <input
                    type="date" id="export-start-date" title="Dari Tanggal"
                    class="form-input block w-full border rounded-md p-3 text-gray-500"> <input type="date"
                    id="export-end-date" title="Sampai Tanggal"
                    class="form-input block w-full border rounded-md p-3 text-gray-500"> <select id="export-category"
                    class="form-input block w-full border rounded-md p-3 bg-white">
                    <option value="all">Semua Kategori</option>
                    <option value="income">Pemasukan Saja</option>
                    <option value="expense">Pengeluaran Saja</option>
                </select> <select id="export-format" class="form-input block w-full border rounded-md p-3 bg-white">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel (XLSX)</option>
                </select>
                <div class="pt-4 flex justify-end space-x-3"> <button type="button"
                        class="btn-cancel bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 font-semibold transition-colors">Batal</button>
                    <button type="submit"
                        class="bg-success text-white px-5 py-2 rounded-lg hover:bg-green-600 font-semibold transition-colors">Buat
                        Laporan</button> </div>
            </form>
        </div>
        <div id="modal-alert"
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-sm hidden text-center">
            <div id="alert-icon" class="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4"> <i
                    class="fas text-3xl"></i> </div>
            <h3 id="alert-title" class="text-lg leading-6 font-bold text-gray-900 dark:text-white">Konfirmasi</h3>
            <div class="mt-2">
                <p id="alert-message" class="text-sm text-gray-600 dark:text-gray-300">Apakah Anda yakin?</p>
            </div>
            <div id="alert-buttons" class="mt-5 flex gap-3 flex-col-reverse sm:flex-row-reverse"> </div>
        </div>
        <div id="modal-transaction-detail"
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-md hidden">
            <div class="flex justify-between items-start mb-4">
                <div id="detail-modal-header"></div> <button
                    class="btn-cancel text-gray-400 hover:text-gray-600 dark:hover:text-white -mt-2 -mr-2"> <i
                        class="fas fa-times text-xl"></i> </button>
            </div>
            <div id="detail-modal-content"
                class="space-y-4 text-sm border-t border-gray-200 dark:border-slate-700 pt-4"></div>
        </div>
        <!-- Edit Profile Modal -->
        <div id="modal-edit-profile"
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-md hidden">
            <h2 class="text-lg font-bold mb-6 text-gray-900 dark:text-white">Edit Profil</h2>
            <form id="form-edit-profile">
                <div class="space-y-4 text-sm">
                    <div class="flex flex-col items-center">
                        <img id="profile-edit-preview" src="" alt="Pratinjau Foto Profil"
                            class="w-24 h-24 rounded-full mb-3 object-cover">
                        <input type="file" id="profile-photo-input" class="hidden" accept="image/*">
                        <label for="profile-photo-input"
                            class="cursor-pointer text-sm font-semibold text-primary-600 dark:text-primary-400 hover:underline">Ubah
                            Foto</label>
                    </div>
                    <div>
                        <label for="profile-name-input"
                            class="block font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Tampilan</label>
                        <input type="text" id="profile-name-input"
                            class="form-input mt-1 block w-full border rounded-md shadow-sm p-3" required>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button"
                        class="btn-cancel bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 font-semibold transition-colors text-sm">Batal</button>
                    <button type="submit"
                        class="bg-primary-600 text-white px-5 py-2 rounded-lg hover:bg-primary-700 w-28 font-semibold transition-colors disabled:bg-primary-300 dark:disabled:bg-primary-800 text-sm">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, query, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChyGY3uPeZUj0jNpN4prLYIAKQeiOb8T8",
            authDomain: "wingman-73.firebaseapp.com",
            projectId: "wingman-73",
            storageBucket: "wingman-73.appspot.com",
            messagingSenderId: "254550350343",
            appId: "1:254550350343:web:a2dec17489e22c2f7aa8a2",
            measurementId: "G-E7745EMJED"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let unsubscribeDoctors = null;
        let unsubscribeTransactions = null;

        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                doctors: [], transactions: [], activePage: 'home', selectedDoctorId: null, transactionSortOrder: 'desc',
                transactionGrouping: 'day', currentPage: 1, currentUser: null,
            };

            const TRANSACTIONS_PER_PAGE = 10;
            const loginPage = document.getElementById('login-page'), appContainer = document.getElementById('app-container'),
                btnGoogleLogin = document.getElementById('btn-google-login'), loginLoader = document.getElementById('login-loader'),
                btnLogout = document.getElementById('btn-logout'), profileAvatar = document.getElementById('profile-avatar'),
                profileName = document.getElementById('profile-name'), profileEmail = document.getElementById('profile-email'),
                userGreeting = document.getElementById('user-greeting'), pages = document.querySelectorAll('.page'),
                navItems = document.querySelectorAll('.nav-item'), modalContainer = document.getElementById('modal-container'),
                doctorList = document.getElementById('doctor-list'), btnAddDoctor = document.getElementById('btn-add-doctor'),
                formDoctor = document.getElementById('form-doctor'), modalDoctorTitle = document.getElementById('modal-doctor-title'),
                doctorIdInput = document.getElementById('doctor-id'), doctorNameInput = document.getElementById('doctor-name'),
                doctorSearchInput = document.getElementById('doctor-search-input'), btnAddTransactionFab = document.getElementById('btn-add-transaction-fab'),
                formTransaction = document.getElementById('form-transaction'), modalTransactionTitle = document.getElementById('modal-transaction-title'),
                transactionIdInput = document.getElementById('transaction-id'), transactionDoctorSelect = document.getElementById('transaction-doctor'),
                transactionTypeBtns = document.querySelectorAll('.transaction-type-btn'), transactionTypeInput = document.getElementById('transaction-type'),
                transactionAmountInput = document.getElementById('transaction-amount'), transactionDescriptionInput = document.getElementById('transaction-description'),
                transactionDateInput = document.getElementById('transaction-date'), transactionTableContainer = document.getElementById('transaction-table-container'),
                paginationControls = document.getElementById('pagination-controls'), dashboardContent = document.getElementById('dashboard-content'),
                doctorSelectDashboard = document.getElementById('doctor-select-dashboard'), recentTransactionsSection = document.getElementById('recent-transactions-section'),
                recentTransactionsContainer = document.getElementById('recent-transactions-container'), btnShowAllTransactions = document.getElementById('show-all-transactions-btn'),
                filterDoctorSelect = document.getElementById('filter-doctor'), filterSearchInput = document.getElementById('filter-search'),
                filterStartDateInput = document.getElementById('filter-start-date'), filterEndDateInput = document.getElementById('filter-end-date'),
                resetFiltersBtn = document.getElementById('reset-filters-btn'), timeGroupTabs = document.getElementById('time-group-tabs'),
                btnSortByDate = document.getElementById('sort-by-date'), btnExport = document.getElementById('btn-export'),
                formExport = document.getElementById('form-export'), themeToggleBtn = document.getElementById('theme-toggle'),
                contactSuggestionBox = document.getElementById('contact-suggestion-box'),
                closeSuggestionBox = document.getElementById('close-suggestion-box'),
                btnEditProfile = document.getElementById('btn-edit-profile'),
                formEditProfile = document.getElementById('form-edit-profile'),
                profileEditPreview = document.getElementById('profile-edit-preview'),
                profilePhotoInput = document.getElementById('profile-photo-input'),
                profileNameInput = document.getElementById('profile-name-input');
            let newPhotoFile = null;

            onAuthStateChanged(auth, (user) => { loginLoader.classList.add('hidden'); btnGoogleLogin.classList.remove('hidden'); if (user) { state.currentUser = user; loginPage.classList.add('hidden'); appContainer.classList.remove('hidden'); appContainer.classList.add('flex'); setupUIForUser(user); setupRealtimeListeners(); } else { state.currentUser = null; loginPage.classList.remove('hidden'); appContainer.classList.add('hidden'); appContainer.classList.remove('flex'); resetState(); if (unsubscribeDoctors) unsubscribeDoctors(); if (unsubscribeTransactions) unsubscribeTransactions(); } });
            btnGoogleLogin.addEventListener('click', async () => { loginLoader.classList.remove('hidden'); btnGoogleLogin.classList.add('hidden'); const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); } catch (error) { showAlert(`Login Gagal: ${error.message}`, 'error'); } });
            btnLogout.addEventListener('click', () => { showConfirm("Apakah Anda yakin ingin keluar?", async () => { try { await signOut(auth); } catch (error) { showAlert(`Logout Gagal: ${error.message}`, 'error'); } }); });
            function setupUIForUser(user) { profileName.textContent = user.displayName; profileEmail.textContent = user.email; profileAvatar.src = user.photoURL || `https://placehold.co/100x100/E2E8F0/4A5568?text=${user.displayName[0]}`; userGreeting.textContent = `Halo, ${user.displayName.split(' ')[0]}!`; }
            function resetState() { state = { doctors: [], transactions: [], activePage: 'home', selectedDoctorId: null, transactionSortOrder: 'desc', transactionGrouping: 'day', currentPage: 1, currentUser: null, }; switchPage('home'); }
            function setupRealtimeListeners() { if (!state.currentUser) return; if (unsubscribeDoctors) unsubscribeDoctors(); if (unsubscribeTransactions) unsubscribeTransactions(); const doctorsColRef = collection(db, "users", state.currentUser.uid, "doctors"); unsubscribeDoctors = onSnapshot(doctorsColRef, (snapshot) => { state.doctors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name)); if (state.selectedDoctorId && !state.doctors.find(d => d.id === state.selectedDoctorId)) { state.selectedDoctorId = null; } populateDoctorSelects(state.selectedDoctorId); rerenderCurrentPage(); }); const transactionsColRef = collection(db, "users", state.currentUser.uid, "transactions"); unsubscribeTransactions = onSnapshot(transactionsColRef, (snapshot) => { state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate().toISOString() })); rerenderCurrentPage(); }); }
            function rerenderCurrentPage() { if (state.activePage === 'home') renderDashboard(); if (state.activePage === 'doctors') renderDoctors(); if (state.activePage === 'transactions') renderTransactions(); }
            const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value || 0);
            const formatNumberInput = (value) => value ? new Intl.NumberFormat('id-ID').format(parseInt(value.replace(/[^0-9]/g, ''), 10) || '') : '';
            const parseFormattedNumber = (value) => parseInt(String(value).replace(/[^0-9-]/g, ''), 10) || 0;
            const formatDateTimeForInput = (date) => new Date(new Date(date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            const showModal = (modalId) => { modalContainer.classList.remove('hidden'); document.querySelectorAll('#modal-container > div').forEach(modal => modal.classList.add('hidden')); document.getElementById(modalId).classList.remove('hidden'); };
            const hideModal = () => { modalContainer.classList.add('hidden'); };
            const showAlert = (message, type = 'info') => { const iconMap = { success: { class: 'bg-green-100 dark:bg-green-900/40', icon: 'fa-check-circle text-success' }, error: { class: 'bg-red-100 dark:bg-red-900/40', icon: 'fa-times-circle text-danger' }, warning: { class: 'bg-yellow-100 dark:bg-yellow-900/40', icon: 'fa-exclamation-triangle text-yellow-500' }, info: { class: 'bg-blue-100 dark:bg-blue-900/40', icon: 'fa-info-circle text-primary-500' } }; const alertTitle = document.getElementById('alert-title'), alertMessage = document.getElementById('alert-message'), alertIconContainer = document.getElementById('alert-icon'), alertIcon = alertIconContainer.querySelector('i'), alertButtons = document.getElementById('alert-buttons'); alertTitle.textContent = { success: 'Berhasil', error: 'Gagal', warning: 'Perhatian', info: 'Informasi' }[type]; alertMessage.textContent = message; alertIconContainer.className = `mx-auto flex items-center justify-center h-14 w-14 rounded-full ${iconMap[type].class} mb-4`; alertIcon.className = `fas ${iconMap[type].icon} text-3xl`; alertButtons.innerHTML = `<button id="alert-ok-btn" class="w-full bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 font-semibold transition-colors text-sm">OK</button>`; showModal('modal-alert'); document.getElementById('alert-ok-btn').focus(); document.getElementById('alert-ok-btn').onclick = hideModal; };
            const showConfirm = (message, onConfirm) => { const alertTitle = document.getElementById('alert-title'), alertMessage = document.getElementById('alert-message'), alertIconContainer = document.getElementById('alert-icon'), alertIcon = alertIconContainer.querySelector('i'), alertButtons = document.getElementById('alert-buttons'); alertTitle.textContent = 'Konfirmasi'; alertMessage.textContent = message; alertIconContainer.className = 'mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-yellow-100 dark:bg-yellow-900/40 mb-4'; alertIcon.className = 'fas fa-exclamation-triangle text-yellow-500 text-3xl'; alertButtons.innerHTML = `<button id="confirm-yes-btn" class="w-full sm:w-auto flex-1 bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold transition-colors text-sm">Ya, Lanjutkan</button> <button id="confirm-no-btn" class="w-full sm:w-auto flex-1 mt-2 sm:mt-0 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 font-semibold transition-colors text-sm">Batal</button>`; showModal('modal-alert'); const yesBtn = document.getElementById('confirm-yes-btn'), noBtn = document.getElementById('confirm-no-btn'); yesBtn.onclick = () => { hideModal(); onConfirm(); }; noBtn.onclick = hideModal; yesBtn.focus(); };
            const switchPage = (pageId) => { state.activePage = pageId; pages.forEach(page => page.classList.add('hidden')); document.getElementById(`page-${pageId}`).classList.remove('hidden'); navItems.forEach(item => { item.classList.toggle('active', item.dataset.page === pageId); }); if (pageId === 'transactions') { filterDoctorSelect.value = 'all'; } rerenderCurrentPage(); };
            const updateTheme = () => { const themeIconContainer = document.getElementById('theme-icon-container'), themeIcon = document.getElementById('theme-icon'); const isDark = document.documentElement.classList.contains('dark'); if (isDark) { themeIconContainer.classList.add('dark:translate-x-6'); themeIconContainer.classList.remove('translate-x-1'); themeIcon.className = 'fas fa-sun text-yellow-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2'; } else { themeIconContainer.classList.remove('dark:translate-x-6'); themeIconContainer.classList.add('translate-x-1'); themeIcon.className = 'fas fa-moon text-primary-700 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2'; } };
            const getDoctorBalance = (doctorId) => state.transactions.filter(t => t.doctorId === doctorId).reduce((bal, t) => bal + (t.type === 'income' ? t.amount : -t.amount), 0);
            const populateDoctorSelects = (selectedId) => { const selects = [doctorSelectDashboard, transactionDoctorSelect, filterDoctorSelect]; selects.forEach(select => { if (!select) return; if (select.id === 'doctor-select-dashboard') { select.innerHTML = `<option value="" selected disabled>--Pilih Dokter--</option>`; } else if (select.id === 'filter-doctor') { select.innerHTML = '<option value="all">Semua Dokter</option>'; } else { select.innerHTML = ''; } state.doctors.forEach(doc => { const option = document.createElement('option'); option.value = doc.id; option.textContent = doc.name; select.appendChild(option); }); if (selectedId) { select.value = selectedId; } }); };
            function renderDashboard() { if (!state.currentUser) return; populateDoctorSelects(state.selectedDoctorId); const suggestionClosed = sessionStorage.getItem('suggestionClosed'); if (state.doctors.length === 0) { doctorSelectDashboard.classList.add('hidden'); dashboardContent.innerHTML = `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-sm"><p class="text-gray-500 dark:text-gray-400 text-sm">Belum ada dokter. Silakan tambahkan di halaman 'Dokter'.</p></div>`; recentTransactionsSection.classList.add('hidden'); if (!suggestionClosed) { contactSuggestionBox.classList.remove('hidden'); } return; } doctorSelectDashboard.classList.remove('hidden'); if (!state.selectedDoctorId) { dashboardContent.innerHTML = `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-sm"><p class="text-gray-500 dark:text-gray-400 text-sm">Pilih dokter untuk melihat ringkasan keuangan.</p></div>`; recentTransactionsSection.classList.add('hidden'); if (!suggestionClosed) { contactSuggestionBox.classList.remove('hidden'); } return; } contactSuggestionBox.classList.add('hidden'); recentTransactionsSection.classList.remove('hidden'); const doctorTransactions = state.transactions.filter(t => t.doctorId === state.selectedDoctorId), balance = getDoctorBalance(state.selectedDoctorId), totalIncome = doctorTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0), totalExpense = doctorTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0), balanceColorClass = balance < 0 ? 'text-red-300' : 'text-white'; dashboardContent.innerHTML = `<div class="bg-gradient-to-br from-primary-500 to-primary-700 text-white rounded-2xl shadow-lg p-5 flex justify-between items-center"><div><p class="text-base text-primary-200">Saldo Saat Ini</p><p class="text-3xl font-bold ${balanceColorClass}">${formatCurrency(balance)}</p></div><i class="fas fa-wallet text-5xl text-white/50"></i></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4 flex items-center gap-3"><div class="p-3 rounded-full bg-green-100 dark:bg-green-900/40"><i class="fas fa-arrow-down text-lg text-success"></i></div><div><p class="text-xs text-gray-500 dark:text-gray-400">Total Pemasukan</p><p class="text-lg font-semibold text-gray-900 dark:text-white">${formatCurrency(totalIncome)}</p></div></div><div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4 flex items-center gap-3"><div class="p-3 rounded-full bg-red-100 dark:bg-red-900/40"><i class="fas fa-arrow-up text-lg text-danger"></i></div><div><p class="text-xs text-gray-500 dark:text-gray-400">Total Pengeluaran</p><p class="text-lg font-semibold text-gray-900 dark:text-white">${formatCurrency(totalExpense)}</p></div></div></div>`; const recentTransactions = doctorTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5); if (recentTransactions.length === 0) { recentTransactionsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-4 text-sm">Tidak ada transaksi untuk dokter ini.</p>'; btnShowAllTransactions.classList.add('hidden'); return; } btnShowAllTransactions.classList.remove('hidden'); recentTransactionsContainer.innerHTML = '<ul class="space-y-2">' + recentTransactions.map(t => { const isIncome = t.type === 'income'; return `<li class="transaction-item-clickable bg-white dark:bg-slate-800 rounded-xl shadow-sm p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors" data-id="${t.id}"><div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0 ${isIncome ? 'bg-green-100 dark:bg-green-900/40 text-success' : 'bg-red-100 dark:bg-red-900/40 text-danger'}"><i class="fas ${isIncome ? 'fa-arrow-down' : 'fa-arrow-up'} text-sm"></i></div><div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 dark:text-gray-100 truncate" title="${t.description}">${t.description}</p><p class="text-xs text-gray-400">${new Date(t.date).toLocaleString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</p></div><p class="font-bold text-base flex-shrink-0 text-right ${isIncome ? 'text-success' : 'text-danger'}">${isIncome ? '+' : ''}${formatCurrency(isIncome ? t.amount : -t.amount)}</p></li>`; }).join('') + '</ul>'; }
            function renderDoctors() { const searchTerm = doctorSearchInput.value.toLowerCase(); const filteredDoctors = state.doctors.filter(doc => doc.name.toLowerCase().includes(searchTerm)); if (filteredDoctors.length === 0) { doctorList.innerHTML = `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-sm"><p class="text-sm text-gray-500 dark:text-gray-400">${searchTerm ? 'Dokter tidak ditemukan.' : 'Belum ada dokter terdaftar.'}</p></div>`; return; } doctorList.innerHTML = filteredDoctors.map(doc => { const balance = getDoctorBalance(doc.id); return `<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-3 flex justify-between items-center transition-all hover:shadow-md"><div class="flex items-center min-w-0 gap-3"><div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/40 flex items-center justify-center flex-shrink-0"><i class="fas fa-user-md text-xl text-primary-600 dark:text-primary-400"></i></div><div class="min-w-0"><h3 class="font-bold text-base text-gray-900 dark:text-white truncate">${doc.name}</h3><p class="text-xs font-medium ${balance < 0 ? 'text-danger' : 'text-gray-500 dark:text-gray-300'}">Saldo: ${formatCurrency(balance)}</p></div></div><div class="space-x-1 flex-shrink-0"><button class="btn-edit-doctor w-8 h-8 rounded-full text-blue-500 hover:bg-blue-100 dark:hover:bg-slate-700" data-id="${doc.id}"><i class="fas fa-edit text-xs"></i></button><button class="btn-delete-doctor w-8 h-8 rounded-full text-danger hover:bg-red-100 dark:hover:bg-slate-700" data-id="${doc.id}"><i class="fas fa-trash text-xs"></i></button></div></div>`; }).join(''); }
            const getFilteredAndSortedTransactions = () => { let transactions = [...state.transactions]; if (filterDoctorSelect.value !== 'all') transactions = transactions.filter(t => t.doctorId === filterDoctorSelect.value); if (filterSearchInput.value) transactions = transactions.filter(t => t.description.toLowerCase().includes(filterSearchInput.value.toLowerCase())); if (filterStartDateInput.value) transactions = transactions.filter(t => new Date(t.date) >= new Date(filterStartDateInput.value).setHours(0, 0, 0, 0)); if (filterEndDateInput.value) transactions = transactions.filter(t => new Date(t.date) <= new Date(filterEndDateInput.value).setHours(23, 59, 59, 999)); transactions.sort((a, b) => state.transactionSortOrder === 'desc' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date)); return transactions; };
            const areFiltersActive = () => filterSearchInput.value.trim() !== '' || filterDoctorSelect.value !== 'all' || filterStartDateInput.value !== '' || filterEndDateInput.value !== '';
            const renderTransactions = () => { paginationControls.innerHTML = ''; const filteredTransactions = getFilteredAndSortedTransactions(); const summaryContainer = document.getElementById('transaction-summary'); if (areFiltersActive()) { const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); summaryContainer.innerHTML = `<p class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Total dari Hasil Filter:</p><div class="flex justify-between items-center text-sm flex-wrap gap-2"><span class="text-success font-medium">Pemasukan: ${formatCurrency(totalIncome)}</span><span class="text-danger font-medium">Pengeluaran: ${formatCurrency(totalExpense)}</span><span class="font-bold text-gray-800 dark:text-gray-100">Total: ${formatCurrency(totalIncome - totalExpense)}</span></div>`; summaryContainer.classList.remove('hidden'); } else { summaryContainer.classList.add('hidden'); } document.querySelectorAll('.group-tab').forEach(tab => { tab.classList.toggle('bg-white', tab.dataset.group === state.transactionGrouping); tab.classList.toggle('dark:bg-slate-700', tab.dataset.group === state.transactionGrouping); tab.classList.toggle('text-primary-600', tab.dataset.group === state.transactionGrouping); tab.classList.toggle('shadow-sm', tab.dataset.group === state.transactionGrouping); }); if (state.transactionGrouping === 'day') { paginationControls.classList.remove('hidden'); const totalPages = Math.ceil(filteredTransactions.length / TRANSACTIONS_PER_PAGE); if (state.currentPage > totalPages && totalPages > 0) state.currentPage = totalPages; const paginatedTransactions = filteredTransactions.slice((state.currentPage - 1) * TRANSACTIONS_PER_PAGE, state.currentPage * TRANSACTIONS_PER_PAGE); renderTransactionTable(paginatedTransactions); if (totalPages > 1) renderPaginationControls(totalPages); } else { paginationControls.classList.add('hidden'); renderTransactionSummary(filteredTransactions, state.transactionGrouping); } };
            const renderTransactionTable = (transactions) => { if (!transactions.length) { transactionTableContainer.innerHTML = `<div class="text-center py-12"><i class="fas fa-search-dollar text-4xl text-gray-300 dark:text-gray-600"></i><p class="mt-4 text-sm text-gray-500">Tidak ada transaksi ditemukan.</p></div>`; return; } let tableHtml = `<ul class="space-y-2 p-3">`; transactions.forEach(t => { const doctor = state.doctors.find(d => d.id === t.doctorId); const isIncome = t.type === 'income'; tableHtml += `<li class="transaction-item-clickable bg-gray-50 dark:bg-slate-800/50 rounded-xl p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700/50" data-id="${t.id}"><div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0 ${isIncome ? 'bg-green-100 dark:bg-green-900/40 text-success' : 'bg-red-100 dark:bg-red-900/40 text-danger'}"><i class="fas ${isIncome ? 'fa-arrow-down' : 'fa-arrow-up'} text-sm"></i></div><div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 dark:text-gray-100 truncate" title="${t.description}">${t.description}</p><p class="text-xs text-gray-500 dark:text-gray-400">${doctor ? doctor.name : 'Dokter Dihapus'} &bull; ${new Date(t.date).toLocaleDateString('id-ID')}</p></div><div class="text-right flex-shrink-0 ml-2"><p class="font-bold text-base ${isIncome ? 'text-success' : 'text-danger'}">${isIncome ? '+' : ''}${formatCurrency(isIncome ? t.amount : -t.amount)}</p><div class="space-x-2 mt-1"><button class="btn-edit-transaction text-xs text-blue-500 hover:underline" data-id="${t.id}">Edit</button><button class="btn-delete-transaction text-xs text-danger hover:underline" data-id="${t.id}">Hapus</button></div></div></li>`; }); tableHtml += '</ul>'; transactionTableContainer.innerHTML = tableHtml; };
            const renderTransactionSummary = (transactions, grouping) => { const getGroupKey = (date, groupType) => { const d = new Date(date); if (groupType === 'week') { const first = d.getDate() - d.getDay() + 1; const firstDay = new Date(d.setDate(first)); return `Minggu, ${firstDay.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })}`; } if (groupType === 'month') return d.toLocaleString('id-ID', { year: 'numeric', month: 'long' }); if (groupType === 'year') return d.getFullYear().toString(); }; const grouped = transactions.reduce((acc, t) => { const key = getGroupKey(t.date, grouping); if (!acc[key]) acc[key] = { income: 0, expense: 0, date: new Date(t.date) }; acc[key][t.type] += t.amount; return acc; }, {}); const sortedKeys = Object.keys(grouped).sort((a, b) => grouped[b].date - grouped[a].date); if (sortedKeys.length === 0) { transactionTableContainer.innerHTML = `<div class="text-center py-12"><i class="fas fa-chart-pie text-4xl text-gray-300 dark:text-gray-600"></i><p class="mt-4 text-sm text-gray-500">Tidak ada data untuk diringkas.</p></div>`; return; } let summaryHtml = `<div class="p-3 space-y-2">`; sortedKeys.forEach(key => { const data = grouped[key]; const total = data.income - data.expense; summaryHtml += `<div class="bg-gray-50 dark:bg-slate-800/50 rounded-xl p-3"><div class="flex justify-between items-baseline mb-2"><h4 class="font-semibold text-sm text-gray-800 dark:text-white">${key}</h4><p class="font-bold text-base ${total < 0 ? 'text-danger' : 'text-gray-900 dark:text-white'}">${formatCurrency(total)}</p></div><div class="flex justify-between text-xs"><p class="text-success">+ ${formatCurrency(data.income)}</p><p class="text-danger">${formatCurrency(-data.expense)}</p></div></div>`; }); summaryHtml += `</div>`; transactionTableContainer.innerHTML = summaryHtml; };
            const renderPaginationControls = (totalPages) => { const prevDisabled = state.currentPage === 1 ? 'disabled' : ''; const nextDisabled = state.currentPage === totalPages ? 'disabled' : ''; paginationControls.innerHTML = `<div class="flex justify-between items-center text-xs text-gray-600 dark:text-gray-400"><button id="prev-page-btn" class="px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" ${prevDisabled}><i class="fas fa-chevron-left"></i>&nbsp; Baru</button><span>Hal ${state.currentPage} / ${totalPages}</span><button id="next-page-btn" class="px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" ${nextDisabled}>Lama &nbsp;<i class="fas fa-chevron-right"></i></button></div>`; };
            const handleDoctorSubmit = async (e) => { e.preventDefault(); const submitBtn = formDoctor.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const id = doctorIdInput.value, name = doctorNameInput.value.trim(); if (!name) { showAlert('Nama dokter tidak boleh kosong.', 'error'); } else if (state.doctors.some(d => d.name.toLowerCase() === name.toLowerCase() && d.id !== id)) { showAlert(`Nama dokter "${name}" sudah ada.`, 'error'); } else { try { const colRef = collection(db, "users", state.currentUser.uid, "doctors"); if (id) await updateDoc(doc(colRef, id), { name }); else await addDoc(colRef, { name }); hideModal(); showAlert(`Dokter berhasil ${id ? 'diperbarui' : 'ditambahkan'}!`, 'success'); } catch (error) { showAlert(`Gagal menyimpan: ${error.message}`, 'error'); } } submitBtn.disabled = false; submitBtn.textContent = 'Simpan'; };
            const handleTransactionSubmit = async (e) => { e.preventDefault(); const submitBtn = formTransaction.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const id = transactionIdInput.value; const data = { doctorId: transactionDoctorSelect.value, type: transactionTypeInput.value, amount: parseFormattedNumber(transactionAmountInput.value), description: transactionDescriptionInput.value.trim(), date: new Date(transactionDateInput.value) }; if (!data.doctorId || !data.type || data.amount <= 0 || !data.description || !data.date || isNaN(data.date)) { showAlert('Harap isi semua kolom dengan benar.', 'error'); } else { try { const colRef = collection(db, "users", state.currentUser.uid, "transactions"); if (id) await updateDoc(doc(colRef, id), data); else await addDoc(colRef, data); state.selectedDoctorId = data.doctorId; hideModal(); switchPage('home'); showAlert(`Transaksi berhasil ${id ? 'diperbarui' : 'ditambahkan'}!`, 'success'); } catch (error) { showAlert(`Gagal menyimpan: ${error.message}`, 'error'); } } submitBtn.disabled = false; submitBtn.textContent = 'Simpan'; };
            const setTransactionType = (type) => { transactionTypeInput.value = type; transactionTypeBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.type === type)); };
            const openDoctorModal = (id = null) => { formDoctor.reset(); formDoctor.querySelector('button[type="submit"]').disabled = false; formDoctor.querySelector('button[type="submit"]').textContent = 'Simpan'; if (id) { const doctor = state.doctors.find(d => d.id === id); if (!doctor) return; modalDoctorTitle.textContent = 'Edit Dokter'; doctorIdInput.value = doctor.id; doctorNameInput.value = doctor.name; } else { modalDoctorTitle.textContent = 'Tambah Dokter Baru'; doctorIdInput.value = ''; } showModal('modal-doctor'); doctorNameInput.focus(); };
            const openTransactionModal = (id = null) => { formTransaction.reset(); formTransaction.querySelector('button[type="submit"]').disabled = false; formTransaction.querySelector('button[type="submit"]').textContent = 'Simpan'; populateDoctorSelects(); if (id) { const t = state.transactions.find(t => t.id === id); if (!t) return; modalTransactionTitle.textContent = 'Edit Transaksi'; transactionIdInput.value = t.id; transactionDoctorSelect.value = t.doctorId; setTransactionType(t.type); transactionAmountInput.value = formatNumberInput(String(t.amount)); transactionDescriptionInput.value = t.description; transactionDateInput.value = formatDateTimeForInput(t.date); } else { modalTransactionTitle.textContent = 'Tambah Transaksi Baru'; transactionIdInput.value = ''; transactionDateInput.value = formatDateTimeForInput(new Date()); if (state.selectedDoctorId) transactionDoctorSelect.value = state.selectedDoctorId; setTransactionType('expense'); } showModal('modal-transaction'); };
            const deleteDoctor = async (id) => { const doctor = state.doctors.find(d => d.id === id); if (!doctor) return; const transactionCount = state.transactions.filter(t => t.doctorId === id).length; const message = `Yakin ingin menghapus ${doctor.name}? Seluruh ${transactionCount} transaksi yang terhubung juga akan dihapus permanen.`; showConfirm(message, async () => { try { const batch = writeBatch(db); batch.delete(doc(db, "users", state.currentUser.uid, "doctors", id)); const q = query(collection(db, "users", state.currentUser.uid, "transactions"), where("doctorId", "==", id)); const querySnapshot = await getDocs(q); querySnapshot.forEach(doc => batch.delete(doc.ref)); await batch.commit(); showAlert('Dokter dan transaksinya telah dihapus.', 'success'); } catch (error) { showAlert(`Gagal menghapus: ${error.message}`, 'error'); } }); };
            const deleteTransaction = async (id) => { showConfirm(`Anda yakin ingin menghapus transaksi ini?`, async () => { try { await deleteDoc(doc(db, "users", state.currentUser.uid, "transactions", id)); showAlert('Transaksi berhasil dihapus.', 'success'); } catch (error) { showAlert(`Gagal menghapus: ${error.message}`, 'error'); } }); };
            const openExportModal = () => { const formExport = document.getElementById('form-export'); if (formExport) { formExport.reset(); document.getElementById('export-start-date').value = filterStartDateInput.value; document.getElementById('export-end-date').value = filterEndDateInput.value; showModal('modal-export'); } };
            const handleExportSubmit = (e) => { e.preventDefault(); const title = document.getElementById('export-title').value.trim(); const startDate = document.getElementById('export-start-date').value; const endDate = document.getElementById('export-end-date').value; const category = document.getElementById('export-category').value; const format = document.getElementById('export-format').value; let transactionsToExport = getFilteredAndSortedTransactions(); const start = startDate ? new Date(startDate).setHours(0, 0, 0, 0) : null; const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : null; if (start) transactionsToExport = transactionsToExport.filter(t => new Date(t.date) >= start); if (end) transactionsToExport = transactionsToExport.filter(t => new Date(t.date) <= end); if (category !== 'all') transactionsToExport = transactionsToExport.filter(t => t.type === category); if (transactionsToExport.length === 0) { showAlert('Tidak ada data untuk diekspor dengan filter yang dipilih.', 'warning'); return; } hideModal(); if (format === 'pdf') { exportToPdf(transactionsToExport, title, startDate, endDate, category); } else if (format === 'excel') { exportToExcel(transactionsToExport, title); } showAlert('Laporan sedang dibuat...', 'info'); };
            const exportToPdf = (transactions, customTitle, startDate, endDate, category) => { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: "portrait" }); const isAllDoctors = filterDoctorSelect.value === 'all'; const doctorName = isAllDoctors ? 'Semua Dokter' : state.doctors.find(d => d.id === filterDoctorSelect.value)?.name || 'Dokter'; const reportTitle = customTitle || `Laporan Keuangan`; const finalTitle = !isAllDoctors ? `${reportTitle} - Dr. ${doctorName}` : reportTitle; doc.setFontSize(18); doc.text(finalTitle, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' }); doc.setFontSize(11); doc.text(`Pengguna: ${state.currentUser.displayName}`, 14, 30); doc.setLineWidth(0.5); doc.line(14, 35, doc.internal.pageSize.getWidth() - 14, 35); let y = 45; const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); const finalBalance = totalIncome - totalExpense; const dateRange = startDate && endDate ? `${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}` : 'Semua Periode'; let summaryBody = [['Periode Laporan', `: ${dateRange}`]]; if (category === 'all') { summaryBody.push(['Total Pemasukan', `: ${formatCurrency(totalIncome)}`], ['Total Pengeluaran', `: ${formatCurrency(totalExpense)}`], ['Saldo Akhir', `: ${formatCurrency(finalBalance)}`]); } else if (category === 'income') { summaryBody.push(['Total Pemasukan', `: ${formatCurrency(totalIncome)}`]); } else if (category === 'expense') { summaryBody.push(['Total Pengeluaran', `: ${formatCurrency(totalExpense)}`]); } doc.autoTable({ body: summaryBody, startY: y, theme: 'plain', styles: { fontSize: 10, cellPadding: 1 }, columnStyles: { 0: { fontStyle: 'bold' } } }); const tableStartY = doc.autoTable.previous.finalY + 10; const head = isAllDoctors ? [['No', 'Tanggal', 'Dokter', 'Keterangan', 'Pemasukan', 'Pengeluaran']] : [['No', 'Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran']]; const body = transactions.map((t, index) => { const doctor = state.doctors.find(d => d.id === t.doctorId); const rowData = [index + 1, new Date(t.date).toLocaleDateString('id-ID')]; if (isAllDoctors) { rowData.push(doctor ? doctor.name : 'N/A'); } rowData.push(t.description); rowData.push(t.type === 'income' ? formatCurrency(t.amount).replace(/Rp\s?/, '') : ''); rowData.push(t.type === 'expense' ? formatCurrency(t.amount).replace(/Rp\s?/, '') : ''); return rowData; }); let columnStyles = {}; if (isAllDoctors) { columnStyles = { 0: { halign: 'center', cellWidth: 8 }, 1: { halign: 'center', cellWidth: 20 }, 2: { cellWidth: 30, overflow: 'ellipsize' }, 3: { cellWidth: 'auto' }, 4: { halign: 'right', cellWidth: 28 }, 5: { halign: 'right', cellWidth: 28 } }; } else { columnStyles = { 0: { halign: 'center', cellWidth: 8 }, 1: { halign: 'center', cellWidth: 20 }, 2: { cellWidth: 'auto' }, 3: { halign: 'right', cellWidth: 35 }, 4: { halign: 'right', cellWidth: 35 } }; } doc.autoTable({ startY: tableStartY, head: head, body: body, theme: 'grid', styles: { valign: 'middle', fontSize: 9, cellPadding: 2, }, headStyles: { fillColor: [37, 99, 235], textColor: 255, halign: 'center', fontSize: 9, }, columnStyles: columnStyles, }); doc.save(`${reportTitle}.pdf`); };
            const exportToExcel = (transactions, customTitle) => { const isAllDoctors = filterDoctorSelect.value === 'all'; const doctorName = isAllDoctors ? 'Semua Dokter' : state.doctors.find(d => d.id === filterDoctorSelect.value)?.name || 'Dokter'; const reportTitle = customTitle || `Laporan Keuangan ${doctorName}`; const dataToExport = transactions.map((t, index) => { const doctor = state.doctors.find(d => d.id === t.doctorId); let row = { 'No.': index + 1, 'Tanggal': new Date(t.date).toLocaleString('id-ID'), }; if (isAllDoctors) row['Dokter'] = doctor ? doctor.name : 'N/A'; row['Deskripsi'] = t.description; row['Jenis'] = t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'; row['Jumlah'] = t.amount; return row; }); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Transaksi"); worksheet['!cols'] = isAllDoctors ? [{ wch: 5 }, { wch: 20 }, { wch: 25 }, { wch: 40 }, { wch: 15 }, { wch: 20 }] : [{ wch: 5 }, { wch: 20 }, { wch: 40 }, { wch: 15 }, { wch: 20 }]; XLSX.writeFile(workbook, `${reportTitle}.xlsx`); };
            const openTransactionDetailModal = (transactionId) => { const transaction = state.transactions.find(t => t.id === transactionId); if (!transaction) return; const doctor = state.doctors.find(d => d.id === transaction.doctorId); const modalHeader = document.getElementById('detail-modal-header'), modalContent = document.getElementById('detail-modal-content'); const isIncome = transaction.type === 'income'; modalHeader.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isIncome ? 'bg-green-100 dark:bg-green-900/40' : 'bg-red-100 dark:bg-red-900/40'}"><i class="fas ${isIncome ? 'fa-arrow-down text-success' : 'fa-arrow-up text-danger'}"></i></div><div><h2 class="text-lg font-bold text-gray-900 dark:text-white">${isIncome ? 'Pemasukan' : 'Pengeluaran'}</h2><p class="text-xs text-gray-500 dark:text-gray-400">${doctor ? doctor.name : 'Dokter Dihapus'}</p></div></div>`; modalContent.innerHTML = `<div><p class="text-xs text-gray-500 dark:text-gray-400">Jumlah</p><p class="font-bold text-2xl ${isIncome ? 'text-success' : 'text-danger'}">${formatCurrency(transaction.amount)}</p></div><div><p class="text-xs text-gray-500 dark:text-gray-400">Deskripsi</p><p class="text-gray-800 dark:text-gray-100 whitespace-pre-wrap break-words">${transaction.description || '-'}</p></div><div><p class="text-xs text-gray-500 dark:text-gray-400">Tanggal & Waktu Transaksi</p><p class="text-gray-800 dark:text-gray-100">${new Date(transaction.date).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}</p></div><div><p class="text-xs text-gray-500 dark:text-gray-400">ID Transaksi</p><p class="text-gray-400 dark:text-gray-500 text-xs">${transaction.id}</p></div>`; showModal('modal-transaction-detail'); };
            const handleTransactionClick = (e) => { const item = e.target.closest('.transaction-item-clickable'); if (item && !e.target.closest('button')) { openTransactionDetailModal(item.dataset.id); } };
            const openEditProfileModal = () => { if (!state.currentUser) return; profileNameInput.value = state.currentUser.displayName; profileEditPreview.src = state.currentUser.photoURL || `https://placehold.co/100x100/E2E8F0/4A5568?text=${state.currentUser.displayName[0]}`; newPhotoFile = null; showModal('modal-edit-profile'); };
            const handleProfileUpdate = async (e) => { e.preventDefault(); const submitBtn = formEditProfile.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const newName = profileNameInput.value.trim(); let newPhotoURL = state.currentUser.photoURL; if (!newName) { showAlert('Nama tidak boleh kosong.', 'error'); submitBtn.disabled = false; submitBtn.textContent = 'Simpan'; return; } try { if (newPhotoFile) { const storageRef = ref(storage, `users/${state.currentUser.uid}/profile.jpg`); await uploadBytes(storageRef, newPhotoFile); newPhotoURL = await getDownloadURL(storageRef); } await updateProfile(auth.currentUser, { displayName: newName, photoURL: newPhotoURL }); hideModal(); showAlert('Profil berhasil diperbarui!', 'success'); setupUIForUser(auth.currentUser); } catch (error) { console.error("Profile Update Error:", error); showAlert(`Gagal memperbarui profil: ${error.message}`, 'error'); } finally { submitBtn.disabled = false; submitBtn.textContent = 'Simpan'; } };

            navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
            modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer || e.target.closest('.btn-cancel')) hideModal(); });
            transactionAmountInput.addEventListener('input', (e) => { const { value, selectionStart } = e.target; const formatted = formatNumberInput(value); e.target.value = formatted; e.target.setSelectionRange(selectionStart + (formatted.length - value.length), selectionStart + (formatted.length - value.length)); });
            btnAddDoctor.addEventListener('click', () => openDoctorModal());
            formDoctor.addEventListener('submit', handleDoctorSubmit);
            doctorList.addEventListener('click', e => { if (e.target.closest('.btn-edit-doctor')) openDoctorModal(e.target.closest('.btn-edit-doctor').dataset.id); if (e.target.closest('.btn-delete-doctor')) deleteDoctor(e.target.closest('.btn-delete-doctor').dataset.id); });
            doctorSearchInput.addEventListener('input', renderDoctors);
            btnAddTransactionFab.addEventListener('click', () => openTransactionModal());
            formTransaction.addEventListener('submit', handleTransactionSubmit);
            transactionTypeBtns.forEach(btn => btn.addEventListener('click', e => { e.preventDefault(); setTransactionType(btn.dataset.type); }));
            recentTransactionsContainer.addEventListener('click', handleTransactionClick);
            transactionTableContainer.addEventListener('click', (e) => { if (e.target.closest('button.btn-edit-transaction')) { openTransactionModal(e.target.closest('button').dataset.id); } else if (e.target.closest('button.btn-delete-transaction')) { deleteTransaction(e.target.closest('button').dataset.id); } else { handleTransactionClick(e); } });
            btnShowAllTransactions.addEventListener('click', () => { filterDoctorSelect.value = state.selectedDoctorId || 'all'; switchPage('transactions'); });
            doctorSelectDashboard.addEventListener('change', (e) => { state.selectedDoctorId = e.target.value; renderDashboard(); });
            [filterDoctorSelect, filterSearchInput, filterStartDateInput, filterEndDateInput].forEach(el => { el.addEventListener('input', () => { state.currentPage = 1; renderTransactions(); }); el.addEventListener('change', () => { state.currentPage = 1; renderTransactions(); }); });
            resetFiltersBtn.addEventListener('click', () => { filterSearchInput.value = ''; filterDoctorSelect.value = 'all'; filterStartDateInput.value = ''; filterEndDateInput.value = ''; state.currentPage = 1; renderTransactions(); });
            timeGroupTabs.addEventListener('click', e => { if (e.target.closest('.group-tab')) { state.currentPage = 1; state.transactionGrouping = e.target.closest('.group-tab').dataset.group; renderTransactions(); } });
            btnSortByDate.addEventListener('click', () => { state.currentPage = 1; state.transactionSortOrder = state.transactionSortOrder === 'desc' ? 'asc' : 'desc'; btnSortByDate.querySelector('i').className = `fas mr-1 ${state.transactionSortOrder === 'desc' ? 'fa-sort-amount-down-alt' : 'fa-sort-amount-up-alt'}`; renderTransactions(); });
            paginationControls.addEventListener('click', e => { if (e.target.closest('#prev-page-btn') && state.currentPage > 1) { state.currentPage--; renderTransactions(); } if (e.target.closest('#next-page-btn')) { const totalPages = Math.ceil(getFilteredAndSortedTransactions().length / TRANSACTIONS_PER_PAGE); if (state.currentPage < totalPages) { state.currentPage++; renderTransactions(); } } });
            btnExport.addEventListener('click', openExportModal);
            if (formExport) formExport.addEventListener('submit', handleExportSubmit);
            themeToggleBtn.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('wingmanTheme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); updateTheme(); });
            closeSuggestionBox.addEventListener('click', () => { contactSuggestionBox.classList.add('hidden'); sessionStorage.setItem('suggestionClosed', 'true'); });
            btnEditProfile.addEventListener('click', openEditProfileModal);
            formEditProfile.addEventListener('submit', handleProfileUpdate);
            profilePhotoInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { newPhotoFile = file; const reader = new FileReader(); reader.onload = (e) => { profileEditPreview.src = e.target.result; }; reader.readAsDataURL(file); } });

            const init = () => { updateTheme(); btnSortByDate.querySelector('i').className = 'fas mr-1 fa-sort-amount-down-alt'; };
            init();
        });
    </script>
</body>

</html>
